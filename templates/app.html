<!DOCTYPE html>
<html>
<head>
    <title>Spolujízda - Kompletní aplikace</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px; }
        .nav { display: flex; gap: 15px; }
        .nav button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .nav button.active { background: #0056b3; }
        .section { display: none; }
        .section.active { display: block !important; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; }
        .btn { padding: 15px 30px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .search-form { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .ride { border: 1px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 8px; background: #f9f9f9; }
        .user-info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Spolujízda</h1>
            <div class="nav">
                <button onclick="showSection('search')" class="active">Hledat jízdu</button>
                <button onclick="showSection('offer')" id="offerBtn" style="display:none;">Nabídnout jízdu</button>
                <button onclick="showSection('my-rides')" id="myRidesBtn" style="display:none;">🚗 Mnou nabízené jízdy</button>
                <button onclick="showSection('map'); loadMapRides();">🗺️ Mapa</button>
                <button onclick="showSection('reservations')" id="reservationsBtn" style="display:none;">🎫 Moje rezervace</button>
                <button onclick="showSection('login')" id="loginBtn">Přihlásit</button>
                <button onclick="showSection('register')" id="registerBtn">Registrovat</button>
                <button onclick="logout()" id="logoutBtn" style="display:none;">Odhlásit</button>
            </div>
        </div>

        <div id="userInfo" class="user-info" style="display:none;"></div>
        <div id="message"></div>

        <!-- Hledání jízd -->
        <div id="search" class="section active">
            <h2>Hledat jízdy</h2>
            <form onsubmit="search(); return false;" class="search-form">
                <input type="text" id="from" placeholder="Odkud - město (Praha, Brno, Ostrava...)" />
                <input type="text" id="fromStreet" placeholder="Odkud - ulice (volitelné)" />
                <input type="text" id="to" placeholder="Kam - město (Praha, Brno, Ostrava...)" />
                <input type="text" id="toStreet" placeholder="Kam - ulice (volitelné)" />
                <div style="margin: 10px 0;">
                    <label>Vzdálenost od mé polohy: <span id="rangeValue">50</span> km</label><br>
                    <input type="range" id="searchRange" min="0" max="100" value="50" oninput="updateRangeValue(this.value)" style="width: 100%; margin: 5px 0;">
                </div>
                <button type="submit" class="btn">🔍 Hledat jízdy v zadaném okolí</button>
                <button type="button" class="btn btn-success" onclick="showAll()">📋 Všechny jízdy</button>
                <button type="button" class="btn" onclick="showMyLocation()" style="background: #17a2b8;">📍 Moje poloha</button>
            </form>
            
            <!-- Mapa pro vyhledávání -->
            <div id="searchMap" style="width: 100%; height: 300px; border: 2px solid #ddd; border-radius: 8px; margin: 15px 0;"></div>
            
            <div id="searchResults"></div>
        </div>

        <!-- Přihlášení -->
        <div id="login" class="section">
            <h2>Přihlášení</h2>
            <div class="form-group">
                <label>Telefon nebo email:</label>
                <input type="text" id="loginPhone" placeholder="+420123456789 nebo email@example.com" onkeypress="if(event.key==='Enter') login()" />
            </div>
            <div class="form-group">
                <label>Heslo:</label>
                <input type="password" id="loginPassword" onkeypress="if(event.key==='Enter') login()" />
            </div>
            <button class="btn" onclick="login()">Přihlásit se</button>
        </div>

        <!-- Registrace -->
        <div id="register" class="section">
            <h2>Registrace</h2>
            <div class="form-group">
                <label>Jméno:</label>
                <input type="text" id="regName" placeholder="Jan Novák" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div class="form-group">
                <label>Telefon:</label>
                <input type="text" id="regPhone" placeholder="+420123456789" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div class="form-group">
                <label>Email (volitelný):</label>
                <input type="email" id="regEmail" placeholder="jan@example.com" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div class="form-group">
                <label>Heslo:</label>
                <input type="password" id="regPassword" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div class="form-group">
                <label>Potvrzení hesla:</label>
                <input type="password" id="regPasswordConfirm" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div style="margin: 15px 0; font-size: 12px; color: #666;">
                <label><input type="checkbox" id="agreeTerms" required> Souhlasím s <a href="/terms" target="_blank">obchodními podmínkami</a></label><br>
                <label><input type="checkbox" id="agreePrivacy" required> Souhlasím se <a href="/privacy" target="_blank">zpracováním osobních údajů</a></label>
            </div>
            <button class="btn" onclick="register()">Registrovat se</button>
        </div>

        <!-- Mapa jízd -->
        <div id="map" class="section">
            <h2>🗺️ Mapa jízd</h2>
            <div id="realMap" style="width: 100%; height: 500px; border: 2px solid #ddd; border-radius: 8px;"></div>
            
            <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;" id="mapRidesList">
                <!-- Jízdy se načtou zde -->
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #dee2e6;">
                <h4 style="margin: 0 0 10px 0; color: #495057;">🗺️ Legenda mapy:</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px;">
                    <div><span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 10px; font-weight: bold; margin-right: 8px; font-size: 10px;">START</span>Odkud jede auto</div>
                    <div><span style="background: #f44336; color: white; padding: 2px 6px; border-radius: 10px; font-weight: bold; margin-right: 8px; font-size: 10px;">CÍL</span>Kam jede auto</div>
                    <div><span style="color: #2196f3; font-weight: bold; margin-right: 8px;">—</span>Trasa mezi městy</div>
                </div>
            </div>
            <button class="btn" onclick="loadMapRides()" style="margin-top: 15px;">🔄 Načíst jízdy</button>
            <button class="btn" onclick="startLocationTracking()" id="trackingBtn" style="margin-top: 15px; margin-left: 10px;">📍 Sdílet polohu</button>
            <button class="btn" onclick="showAllUserLocations()" style="margin-top: 15px; margin-left: 10px;">👥 Zobrazit uživatele</button>
        </div>

        <!-- Rezervované jízdy -->
        <div id="reservations" class="section">
            <h2>🎫 Moje rezervace</h2>
            <div id="reservationsList">
                <p>Načítám vaše rezervace...</p>
            </div>
            <button class="btn" onclick="loadReservations()" style="margin-top: 15px;">🔄 Aktualizovat</button>
        </div>

        <!-- Moje jízdy (pro řidiče) -->
        <div id="my-rides" class="section">
            <h2>🚗 Moje jízdy</h2>
            <div id="myRidesList">
                <p>Načítám vaše jízdy...</p>
            </div>
            <button class="btn" onclick="loadMyRides()" style="margin-top: 15px;">🔄 Aktualizovat</button>
        </div>

        <!-- Chat -->
        <div id="chat" class="section">
            <h2 id="chatTitle">💬 Chat</h2>
            <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin: 15px 0; background: #f9f9f9;">
                <p style="text-align: center; color: #666;">Vyberte chat...</p>
            </div>
            <div id="chatInput" style="display: none;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="messageInput" placeholder="Napište zprávu..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn" onclick="sendMessage()">📨 Odeslat</button>
                </div>
            </div>
        </div>

        <!-- Hodnocení -->
        <div id="rating" class="section">
            <h2 id="ratingTitle">⭐ Hodnocení</h2>
            <div id="ratingContent" style="text-align: center; padding: 30px;">
                <h3 id="ratingUserName">Hodnotit uživatele</h3>
                <div style="margin: 20px 0;">
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(1)" id="star1">☆</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(2)" id="star2">☆</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(3)" id="star3">☆</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(4)" id="star4">☆</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(5)" id="star5">☆</span>
                </div>
                <div style="margin: 20px 0;">
                    <textarea id="ratingComment" placeholder="Komentář (volitelný)..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <div>
                    <button class="btn btn-success" onclick="submitRating()">⭐ Odeslat hodnocení</button>
                    <button class="btn" onclick="showSection('reservations')" style="margin-left: 10px;">❌ Zrušit</button>
                </div>
            </div>
        </div>

        <!-- Nabídka jízdy -->
        <div id="offer" class="section">
            <h2>Nabídnout jízdu</h2>
            <div class="form-group">
                <label>Odkud - město:</label>
                <input type="text" id="offerFrom" placeholder="Praha, Brno, Ostrava..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Odkud - ulice (volitelné):</label>
                <input type="text" id="offerFromStreet" placeholder="Náměstí Míru, Hlavní nádraží..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Kam - město:</label>
                <input type="text" id="offerTo" placeholder="Praha, Brno, Ostrava..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Kam - ulice (volitelné):</label>
                <input type="text" id="offerToStreet" placeholder="Náměstí Míru, Hlavní nádraží..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Datum a čas odjezdu:</label>
                <input type="datetime-local" id="offerTime" />
            </div>
            <div class="form-group">
                <label>Počet volných míst:</label>
                <select id="offerSeats">
                    <option value="1">1 místo</option>
                    <option value="2">2 místa</option>
                    <option value="3">3 místa</option>
                    <option value="4">4 místa</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cena za osobu (Kč):</label>
                <input type="number" id="offerPrice" placeholder="Cena za osobu" onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <button class="btn btn-success" onclick="offerRide()">🚗 Nabídnout jízdu</button>
        </div>
        <!-- Footer s právními informacemi -->
        <footer style="margin-top: 50px; padding: 20px 0; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #666;">
            <div style="margin-bottom: 10px;">
                <a href="/terms" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;">Obchodní podmínky</a> |
                <a href="/privacy" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;">Ochrana osobních údajů</a> |
                <a href="mailto:m.zeleny@volny.cz" style="color: #007bff; text-decoration: none; margin: 0 10px;">Kontakt</a>
            </div>
            <div>
                © 2024 Sveztese.cz - Aplikace pro sdílení jízd | IČ: 05402361
            </div>
        </footer>
    </div>

    <!-- Cookie consent banner -->
    <div id="cookieConsent" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: white; padding: 15px; z-index: 10000; text-align: center;">
        <div style="max-width: 900px; margin: 0 auto;">
            <p style="margin: 0 0 10px 0; font-size: 14px;">Používáme cookies pro zlepšení vašeho zážitku. Pokračováním souhlasíte s jejich používáním.</p>
            <button onclick="acceptCookies()" style="background: #007bff; color: white; border: none; padding: 8px 20px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Souhlasím</button>
            <a href="/privacy" target="_blank" style="color: #ccc; text-decoration: none; font-size: 12px;">Více informací</a>
        </div>
    </div>

    <!-- Plovoucí chat okno -->
    <div id="floatingChat" style="display: none; position: fixed; bottom: 20px; right: 20px; width: 350px; height: 400px; background: white; border: 2px solid #007bff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;">
        <div style="background: #007bff; color: white; padding: 10px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span id="floatingChatTitle">💬 Chat</span>
            <button onclick="closeFloatingChat()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">×</button>
        </div>
        <div id="floatingChatMessages" style="height: 280px; overflow-y: auto; padding: 10px; background: #f9f9f9;">
            <p style="text-align: center; color: #666;">Načítám zprávy...</p>
        </div>
        <div style="padding: 10px; border-top: 1px solid #ddd;">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="floatingMessageInput" placeholder="Zpráva..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" onkeypress="if(event.key==='Enter') sendFloatingMessage()">
                <button onclick="sendFloatingMessage()" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">📨</button>
            </div>
        </div>
    </div>

    <script src="/static/js/cookies.js"></script>
    <script>
        let currentUser = null;

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 5000);
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            
            // Najdi a aktivuj správné tlačítko
            const buttons = document.querySelectorAll('.nav button');
            buttons.forEach(btn => {
                if (btn.textContent.includes('Hledat') && section === 'search') btn.classList.add('active');
                if (btn.textContent.includes('Mapa') && section === 'map') btn.classList.add('active');
                if (btn.textContent.includes('Moje rezervace') && section === 'reservations') btn.classList.add('active');
                if (btn.textContent.includes('Mnou nabízené') && section === 'my-rides') btn.classList.add('active');
                if (btn.textContent.includes('Chat') && section === 'chat') btn.classList.add('active');
                if (btn.textContent.includes('Nabídnout') && section === 'offer') btn.classList.add('active');
                if (btn.textContent.includes('Přihlásit') && section === 'login') btn.classList.add('active');
                if (btn.textContent.includes('Registrovat') && section === 'register') btn.classList.add('active');
            });
            
            // Automatické načítání dat při přepnutí na sekci
            if (section === 'reservations') {
                loadReservations();
            } else if (section === 'my-rides') {
                loadMyRides();
            } else if (section === 'search') {
                setTimeout(() => {
                    if (!searchMap) initSearchMap();
                }, 100);
                setTimeout(() => {
                    autoUpdateLocation();
                }, 1000);
            }
        }

        function updateUI() {
            if (currentUser) {
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfo').innerHTML = `Přihlášen jako: <strong>${currentUser.name}</strong> (${currentUser.phone}) ⭐ ${currentUser.rating || 5.0}`;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('registerBtn').style.display = 'none';
                document.getElementById('offerBtn').style.display = 'inline-block';
                document.getElementById('reservationsBtn').style.display = 'inline-block';
                document.getElementById('myRidesBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
            } else {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('registerBtn').style.display = 'inline-block';
                document.getElementById('offerBtn').style.display = 'none';
                document.getElementById('reservationsBtn').style.display = 'none';
                document.getElementById('myRidesBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        async function register() {
            if (!document.getElementById('agreeTerms').checked) {
                showMessage('Musíte souhlasit s obchodními podmínkami', 'error');
                return;
            }
            if (!document.getElementById('agreePrivacy').checked) {
                showMessage('Musíte souhlasit se zpracováním osobních údajů', 'error');
                return;
            }
            

            
            const name = document.getElementById('regName').value.trim();
            const forbiddenNames = ['neznámý řidič', 'neznámý', 'unknown', 'driver', 'řidič', 'neznámy ridic', 'test', 'user'];
            
            if (name.length < 2) {
                showMessage('Jméno musí mít alespoň 2 znaky', 'error');
                return;
            }
            
            if (forbiddenNames.some(forbidden => name.toLowerCase().includes(forbidden))) {
                showMessage('Zadejte platné jméno a příjmení', 'error');
                return;
            }
            
            const data = {
                name: name,
                phone: document.getElementById('regPhone').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                password_confirm: document.getElementById('regPasswordConfirm').value
            };

            try {
                const response = await fetch('/api/users/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Registrace úspěšná! Nyní se můžete přihlásit.');
                    showSection('login');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při registraci: ' + error.message, 'error');
            }
        }

        async function login() {
            const data = {
                phone: document.getElementById('loginPhone').value,
                password: document.getElementById('loginPassword').value
            };

            try {
                const response = await fetch('/api/users/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (response.ok) {
                    currentUser = {
                        id: result.user_id,
                        name: result.name,
                        phone: document.getElementById('loginPhone').value,
                        rating: result.rating || 5.0
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateUI();
                    showMessage('Přihlášení úspěšné!');
                    showSection('search');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při přihlášení: ' + error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUI();
            showMessage('Odhlášení úspěšné!');
            showSection('search');
        }

        async function offerRide() {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }

            const fromCity = document.getElementById('offerFrom').value;
            const fromStreet = document.getElementById('offerFromStreet').value;
            const toCity = document.getElementById('offerTo').value;
            const toStreet = document.getElementById('offerToStreet').value;
            
            const data = {
                user_id: currentUser.id,
                from_location: fromStreet ? `${fromCity}, ${fromStreet}` : fromCity,
                to_location: toStreet ? `${toCity}, ${toStreet}` : toCity,
                departure_time: document.getElementById('offerTime').value,
                available_seats: parseInt(document.getElementById('offerSeats').value),
                price_per_person: parseInt(document.getElementById('offerPrice').value),
                route_waypoints: []
            };

            try {
                const response = await fetch('/api/rides/offer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Jízda úspěšně nabídnuta!');
                    document.getElementById('offer').querySelectorAll('input').forEach(i => i.value = '');
                    showSection('search');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při nabízení jízdy: ' + error.message, 'error');
            }
        }

        async function search() {
            const from = document.getElementById('from').value.trim();
            const fromStreet = document.getElementById('fromStreet') ? document.getElementById('fromStreet').value.trim() : '';
            const to = document.getElementById('to').value.trim();
            const toStreet = document.getElementById('toStreet') ? document.getElementById('toStreet').value.trim() : '';
            
            // Kombinuj město a ulici
            const fromFull = fromStreet ? `${from}, ${fromStreet}` : from;
            const toFull = toStreet ? `${to}, ${toStreet}` : to;
            const rangeSlider = document.getElementById('searchRange').value;
            const results = document.getElementById('searchResults');
            
            results.innerHTML = '⏳ Hledám jízdy...';
            
            try {
                let url = '/api/rides/search?';
                if (fromFull) url += `from=${encodeURIComponent(fromFull)}&`;
                if (toFull) url += `to=${encodeURIComponent(toFull)}&`;
                
                // Přidej GPS polohu a vzdálenost pokud je dostupná
                if (currentLocation && rangeSlider > 0) {
                    const actualRange = Math.round(Math.pow(rangeSlider / 100 * 300, 1.5) / 10);
                    url += `lat=${currentLocation.lat}&lng=${currentLocation.lng}&range=${actualRange}&`;
                } else if (rangeSlider > 0 && !currentLocation) {
                    showMessage('Pro filtrované vyhledávání musíte zapnout GPS polohu', 'error');
                    return;
                }
                
                const response = await fetch(url);
                const rides = await response.json();
                
                if (rides.length === 0) {
                    results.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">❌ Žádné jízdy nenalezeny</div>';
                    return;
                }
                
                results.innerHTML = rides.map(ride => `
                    <div class="ride">
                        <h3>${ride.from_location} → ${ride.to_location}</h3>
                        <div>🕐 ${ride.departure_time} | 👥 ${ride.available_seats} míst | 💰 ${ride.price_per_person} Kč</div>
                        <div>🚗 ${ride.driver_name || 'Neznámý řidič'} ⭐ ${ride.driver_rating || 5.0} <button onclick="showDriverReviews('${ride.driver_name}')" style="background: #17a2b8; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer; margin-left: 5px;">💬 Recenze</button></div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="reserveRide(${ride.id})" style="background: #28a745; margin-right: 10px;">🎫 Rezervovat</button>
                            <button class="btn btn-success" onclick="payForRide(${ride.id}, ${ride.price_per_person})">💳 Zaplatit</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                results.innerHTML = '❌ Chyba: ' + error.message;
            }
        }

        async function showAll() {
            const results = document.getElementById('searchResults');
            results.innerHTML = '⏳ Načítám všechny jízdy...';
            
            try {
                // Ignoruj GPS filtr - načti všechny jízdy bez omezení
                const response = await fetch('/api/rides/search');
                const rides = await response.json();
                
                results.innerHTML = rides.map(ride => `
                    <div class="ride">
                        <h3>${ride.from_location} → ${ride.to_location}</h3>
                        <div>🕐 ${ride.departure_time} | 👥 ${ride.available_seats} míst | 💰 ${ride.price_per_person} Kč</div>
                        <div>🚗 ${ride.driver_name || 'Neznámý řidič'} <button onclick="showDriverReviews('${ride.driver_name}')" style="background: #17a2b8; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer; margin-left: 5px;">💬 Recenze</button></div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="reserveRide(${ride.id})" style="background: #28a745; margin-right: 10px;">🎫 Rezervovat</button>
                            <button class="btn btn-success" onclick="payForRide(${ride.id}, ${ride.price_per_person})">💳 Zaplatit</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                results.innerHTML = '❌ Chyba: ' + error.message;
            }
        }

        async function loadMapRides() {
            const mapRides = document.getElementById('mapRides');
            mapRides.innerHTML = '⏳ Načítám jízdy na mapu...';
            
            try {
                const response = await fetch('/api/rides/all');
                const rides = await response.json();
                
                if (rides.length === 0) {
                    mapRides.innerHTML = '<div style="text-align:center;color:#666;">❌ Žádné jízdy na mapě</div>';
                    return;
                }
                
                mapRides.innerHTML = rides.map((ride, index) => `
                    <div style="background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="background: #007bff; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px; font-weight: bold;">${index + 1}</span>
                            <strong style="color: #007bff;">${ride.from_location} → ${ride.to_location}</strong>
                        </div>
                        <div style="margin-left: 35px; color: #666; font-size: 14px;">
                            🕐 ${ride.departure_time}<br>
                            👥 ${ride.available_seats} volných míst<br>
                            💰 ${ride.price_per_person} Kč/osoba<br>
                            🚗 ${ride.driver_name || 'Neznámý řidič'}
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                mapRides.innerHTML = '❌ Chyba při načítání: ' + error.message;
            }
        }
        
        async function loadMapRides() {
            const ridesList = document.getElementById('mapRidesList');
            ridesList.innerHTML = '⏳ Načítám jízdy na mapu...';
            
            try {
                const response = await fetch('/api/rides/all');
                const rides = await response.json();
                
                // Aktualizuj počet jízd v legendě
                document.getElementById('ridesCount').textContent = rides.length;
                
                ridesList.innerHTML = rides.map((ride, index) => `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="background: #007bff; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px; font-weight: bold;">${index + 1}</span>
                            <strong style="color: #007bff; font-size: 16px;">${ride.from_location} → ${ride.to_location}</strong>
                        </div>
                        <div style="margin-left: 35px; color: #666;">
                            🕐 ${ride.departure_time}<br>
                            👥 ${ride.available_seats} volných míst<br>
                            💰 ${ride.price_per_person} Kč na osobu<br>
                            🚗 ${ride.driver_name || 'Neznámý řidič'}
                        </div>
                    </div>
                `).join('');
                
                showMessage(`Načteno ${rides.length} jízd na mapu!`);
                
            } catch (error) {
                ridesList.innerHTML = '❌ Chyba při načítání: ' + error.message;
            }
        }
        
        let map;
        let markers = [];
        
        function initRealMap() {
            if (map) return;
            
            // Vytvoř mapu střed ČR
            map = L.map('realMap').setView([49.75, 15.5], 7);
            
            // Přidej OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        async function loadMapRides() {
            initRealMap();
            
            // Vymaž staré markery
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            const ridesList = document.getElementById('mapRidesList');
            ridesList.innerHTML = '⏳ Načítám jízdy na mapu...';
            
            try {
                const response = await fetch('/api/rides/all');
                const rides = await response.json();
                
                // Města a jejich souřadnice
                const cities = {
                    'Praha': [50.0755, 14.4378],
                    'Brno': [49.1951, 16.6068],
                    'Ostrava': [49.8209, 18.2625],
                    'Plzeň': [49.7384, 13.3736],
                    'Liberec': [50.7663, 15.0543],
                    'Olomouc': [49.5938, 17.2509],
                    'Zlín': [49.2265, 17.6679],
                    'Rájec Jestřebí': [49.4186, 16.7486],
                    'České Budějovice': [48.9745, 14.4743],
                    'Hradec Králové': [50.2103, 15.8327]
                };
                
                rides.forEach((ride, index) => {
                    const fromCoords = cities[ride.from_location];
                    const toCoords = cities[ride.to_location];
                    
                    if (fromCoords && toCoords) {
                        // Start marker - odkud (zelený START)
                        const startMarker = L.marker(fromCoords, {
                            icon: L.divIcon({
                                html: `<div style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 15px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 12px; white-space: nowrap;">START ${index + 1}</div>`,
                                className: 'custom-marker',
                                iconSize: [60, 25]
                            })
                        }).addTo(map);
                        
                        // End marker - kam (červený CÍL)
                        const endMarker = L.marker(toCoords, {
                            icon: L.divIcon({
                                html: `<div style="background: #f44336; color: white; padding: 4px 8px; border-radius: 15px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 12px; white-space: nowrap;">CÍL ${index + 1}</div>`,
                                className: 'custom-marker',
                                iconSize: [50, 25]
                            })
                        }).addTo(map);
                        
                        // Čára trasy
                        const routeLine = L.polyline([fromCoords, toCoords], {
                            color: '#2196f3',
                            weight: 3,
                            opacity: 0.7
                        }).addTo(map);
                        
                        // Info popup s tlačítky
                        const popupContent = `
                            <div style="min-width: 220px;">
                                <h4 style="margin: 0 0 10px 0; color: #007bff;">${ride.from_location} → ${ride.to_location}</h4>
                                <p style="margin: 5px 0;"><strong>🕐 Čas:</strong> ${ride.departure_time}</p>
                                <p style="margin: 5px 0;"><strong>👥 Místa:</strong> ${ride.available_seats} volných</p>
                                <p style="margin: 5px 0;"><strong>💰 Cena:</strong> ${ride.price_per_person} Kč/osoba</p>
                                <p style="margin: 5px 0;"><strong>🚗 Řidič:</strong> ${ride.driver_name || 'Neznámý'}</p>
                                <div style="margin-top: 15px; text-align: center;">
                                    <button onclick="reserveRide(${ride.id})" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer; font-size: 12px;">🎫 Rezervovat</button>
                                    <button onclick="payForRide(${ride.id}, ${ride.price_per_person})" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">💳 Zaplatit</button>
                                </div>
                            </div>
                        `;
                        
                        startMarker.bindPopup(popupContent);
                        endMarker.bindPopup(popupContent);
                        routeLine.bindPopup(popupContent);
                        
                        markers.push(startMarker, endMarker, routeLine);
                    }
                });
                
                // Seznam jízd pod mapou
                ridesList.innerHTML = rides.map((ride, index) => `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="background: #4caf50; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px; font-weight: bold;">${index + 1}</span>
                            <strong style="color: #007bff; font-size: 16px;">${ride.from_location} → ${ride.to_location}</strong>
                        </div>
                        <div style="margin-left: 35px; color: #666;">
                            🕐 ${ride.departure_time}<br>
                            👥 ${ride.available_seats} volných míst<br>
                            💰 ${ride.price_per_person} Kč na osobu<br>
                            🚗 ${ride.driver_name || 'Neznámý řidič'}
                        </div>
                    </div>
                `).join('');
                
                showMessage(`Načteno ${rides.length} jízd na mapu!`);
                
            } catch (error) {
                ridesList.innerHTML = '❌ Chyba při načítání: ' + error.message;
            }
        }
        
        async function reserveRide(rideId) {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/reservations/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId,
                        passenger_id: currentUser.id,
                        seats_reserved: 1
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Jízda úspěšně rezervována!');
                    // Obnov seznam jízd
                    if (document.getElementById('search').classList.contains('active')) {
                        showAll();
                    }
                    // Automaticky přejdi na rezervace
                    setTimeout(() => {
                        showSection('reservations');
                        loadReservations();
                    }, 1500);
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při rezervaci: ' + error.message, 'error');
            }
        }
        
        async function payForRide(rideId, price) {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/payments/create-checkout-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId,
                        user_id: currentUser.id,
                        amount: price
                    })
                });
                
                const session = await response.json();
                
                if (response.ok) {
                    window.location.href = session.checkout_url;
                } else {
                    showMessage(session.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při platbě: ' + error.message, 'error');
            }
        }
        
        async function loadReservations() {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }
            
            const reservationsList = document.getElementById('reservationsList');
            reservationsList.innerHTML = '⏳ Načítám vaše rezervace...';
            
            try {
                const response = await fetch(`/api/reservations/user/${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const reservations = await response.json();
                
                if (reservations.length === 0) {
                    reservationsList.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">❌ Žádné rezervace</div>';
                    return;
                }
                
                reservationsList.innerHTML = reservations.map(reservation => `
                    <div class="ride">
                        <h3>${reservation.from_location} → ${reservation.to_location}</h3>
                        <div>🕐 ${reservation.departure_time} | 🎫 ${reservation.seats_reserved} místo | 💰 ${reservation.price_per_person} Kč</div>
                        <div>🚗 Řidič: ${reservation.driver_name || 'Neznámý'} | 📞 ${reservation.driver_phone || 'Bez telefonu'}</div>
                        <div style="margin-top: 10px;">
                            <span style="background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">✓ Rezervováno</span>
                            <button class="btn" onclick="openChat('passenger', ${reservation.reservation_id}, '${reservation.driver_name}')" style="background: #17a2b8; margin-left: 10px; padding: 5px 15px;">💬 Chat s řidičem</button>
                            <button class="btn" onclick="rateDriver(${reservation.reservation_id}, '${reservation.driver_name}')" style="background: #ffc107; margin-left: 10px; padding: 5px 15px;">⭐ Hodnotit řidiče</button>
                            <button class="btn btn-success" onclick="payForReservation(${reservation.reservation_id}, ${reservation.price_per_person})" style="margin-left: 10px; padding: 5px 15px;">💳 Zaplatit</button>
                            <button class="btn btn-danger" onclick="cancelReservation(${reservation.reservation_id})" style="margin-left: 10px; padding: 5px 15px;">❌ Zrušit</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                reservationsList.innerHTML = '❌ Chyba při načítání: ' + error.message;
            }
        }
        
        async function payForReservation(reservationId, price) {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/payments/create-checkout-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: reservationId, // Použij reservation_id jako ride_id
                        user_id: currentUser.id,
                        amount: price
                    })
                });
                
                const session = await response.json();
                
                if (response.ok) {
                    window.location.href = session.checkout_url;
                } else {
                    showMessage(session.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při platbě: ' + error.message, 'error');
            }
        }
        
        async function cancelReservation(reservationId) {
            if (!confirm('Opravdu chcete zrušit tuto rezervaci?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/reservations/cancel/${reservationId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Rezervace zrušena!');
                    loadReservations(); // Obnov seznam
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při rušení: ' + error.message, 'error');
            }
        }
        
        async function loadMyRides() {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }
            
            console.log('Loading rides for user:', currentUser.id); // Debug
            
            const myRidesList = document.getElementById('myRidesList');
            myRidesList.innerHTML = '⏳ Načítám vaše jízdy...';
            
            try {
                const response = await fetch(`/api/rides/driver/${currentUser.id}`);
                
                console.log('API response:', response.status); // Debug
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const rides = await response.json();
                console.log('Rides found:', rides.length, rides); // Debug
                
                if (rides.length === 0) {
                    myRidesList.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">❌ Žádné nabízené jízdy</div>';
                    return;
                }
                
                myRidesList.innerHTML = rides.map(ride => `
                    <div class="ride">
                        <h3>${ride.from_location} → ${ride.to_location}</h3>
                        <div>🕐 ${ride.departure_time} | 👥 ${ride.available_seats} volných míst | 💰 ${ride.price_per_person} Kč</div>
                        <div>📋 Rezervace: ${ride.reservations_count || 0} | 💰 Příjem: ${(ride.reservations_count || 0) * ride.price_per_person} Kč</div>
                        <div id="passengers-${ride.id}" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">⏳ Načítám pasažéry...</div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="viewRideReservations(${ride.id})" style="background: #17a2b8; margin-right: 10px;">👥 Detail rezervací</button>
                            <button class="btn" onclick="openChat('driver', ${ride.id}, 'Pasažéři')" style="background: #6f42c1; margin-right: 10px;">💬 Chat</button>
                            <button class="btn btn-danger" onclick="cancelRide(${ride.id})">❌ Zrušit jízdu</button>
                        </div>
                    </div>
                `).join('');
                
                // Načti pasažéry pro každou jízdu
                rides.forEach(ride => loadPassengersForRide(ride.id));
                
            } catch (error) {
                myRidesList.innerHTML = '❌ Chyba při načítání: ' + error.message;
            }
        }
        
        async function viewRideReservations(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/reservations`);
                const reservations = await response.json();
                
                if (reservations.length === 0) {
                    showMessage('Žádné rezervace pro tuto jízdu');
                    return;
                }
                
                let reservationsList = reservations.map(res => 
                    `• ${res.passenger_name}\n  📞 ${res.passenger_phone}\n  🎫 ${res.seats_reserved} místo\n`
                ).join('\n');
                
                alert(`Rezervace pro jízdu:\n\n${reservationsList}`);
                
            } catch (error) {
                showMessage('Chyba při načítání rezervací: ' + error.message, 'error');
            }
        }
        
        async function cancelRide(rideId) {
            if (!confirm('Opravdu chcete zrušit tuto jízdu? Všechny rezervace budou zrušeny.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/rides/cancel/${rideId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Jízda zrušena!');
                    loadMyRides(); // Obnov seznam
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba při rušení jízdy: ' + error.message, 'error');
            }
        }
        
        let currentChatRide = null;
        let currentChatType = null;
        
        function openChat(type, rideId, partnerName) {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }
            
            currentChatRide = rideId;
            currentChatType = type;
            
            console.log('Opening floating chat:', type, rideId, partnerName);
            
            // Otevři plovoucí chat
            document.getElementById('floatingChatTitle').textContent = `💬 ${partnerName}`;
            document.getElementById('floatingChat').style.display = 'block';
            document.getElementById('floatingMessageInput').value = '';
            
            loadFloatingChatMessages(rideId);
        }
        
        function closeFloatingChat() {
            document.getElementById('floatingChat').style.display = 'none';
        }
        
        async function loadFloatingChatMessages(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/messages`);
                const messages = await response.json();
                
                const chatMessages = document.getElementById('floatingChatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<p style="text-align: center; color: #666; font-size: 14px;">Zatím žádné zprávy...</p>';
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => {
                    const isOwn = msg.sender_id === currentUser.id;
                    const align = isOwn ? 'right' : 'left';
                    const bgColor = isOwn ? '#007bff' : '#6c757d';
                    
                    return `
                        <div style="text-align: ${align}; margin: 8px 0;">
                            <div style="display: inline-block; background: ${bgColor}; color: white; padding: 6px 10px; border-radius: 12px; max-width: 80%; font-size: 14px;">
                                <div style="font-size: 11px; opacity: 0.8;">${msg.sender_name}</div>
                                <div>${msg.message}</div>
                                <div style="font-size: 10px; opacity: 0.6;">${new Date(msg.created_at).toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Scroll na konec
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                document.getElementById('floatingChatMessages').innerHTML = '❌ Chyba při načítání zpráv';
            }
        }
        
        async function sendFloatingMessage() {
            const messageInput = document.getElementById('floatingMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentUser || !currentChatRide) {
                return;
            }
            
            try {
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: currentChatRide,
                        sender_id: currentUser.id,
                        message: message
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    loadFloatingChatMessages(currentChatRide);
                } else {
                    showMessage('Chyba při odesílání zprávy', 'error');
                }
                
            } catch (error) {
                showMessage('Chyba při odesílání: ' + error.message, 'error');
            }
        }
        
        async function loadChatMessages(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/messages`);
                const messages = await response.json();
                
                const chatMessages = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<p style="text-align: center; color: #666;">Zatím žádné zprávy...</p>';
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => {
                    const isOwn = msg.sender_id === currentUser.id;
                    const align = isOwn ? 'right' : 'left';
                    const bgColor = isOwn ? '#007bff' : '#6c757d';
                    
                    return `
                        <div style="text-align: ${align}; margin: 10px 0;">
                            <div style="display: inline-block; background: ${bgColor}; color: white; padding: 8px 12px; border-radius: 15px; max-width: 70%;">
                                <div style="font-size: 12px; opacity: 0.8;">${msg.sender_name}</div>
                                <div>${msg.message}</div>
                                <div style="font-size: 10px; opacity: 0.6;">${new Date(msg.created_at).toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Scroll na konec
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                document.getElementById('chatMessages').innerHTML = '❌ Chyba při načítání zpráv';
            }
        }
        
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentUser || !currentChatRide) {
                return;
            }
            
            try {
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: currentChatRide,
                        sender_id: currentUser.id,
                        message: message
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    loadChatMessages(currentChatRide); // Obnov zprávy
                } else {
                    showMessage('Chyba při odesílání zprávy', 'error');
                }
                
            } catch (error) {
                showMessage('Chyba při odesílání: ' + error.message, 'error');
            }
        }
        
        async function loadPassengersForRide(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/reservations`);
                const reservations = await response.json();
                
                const passengersDiv = document.getElementById(`passengers-${rideId}`);
                
                if (reservations.length === 0) {
                    passengersDiv.innerHTML = '<div style="color: #666; font-style: italic;">🚕 Žádní pasažéři</div>';
                    return;
                }
                
                const passengersList = reservations.map(res => 
                    `<div style="margin: 5px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #28a745;">
                        <strong>👤 ${res.passenger_name}</strong> | 📞 ${res.passenger_phone} | 🎫 ${res.seats_reserved} místo
                        <button onclick="ratePassenger('${res.passenger_name}', ${rideId})" style="background: #ffc107; color: black; border: none; padding: 4px 8px; border-radius: 3px; margin-left: 10px; cursor: pointer; font-size: 11px;">⭐ Hodnotit</button>
                    </div>`
                ).join('');
                
                passengersDiv.innerHTML = `<div style="font-weight: bold; margin-bottom: 8px;">👥 Pasažéři:</div>${passengersList}`;
                
            } catch (error) {
                const passengersDiv = document.getElementById(`passengers-${rideId}`);
                if (passengersDiv) {
                    passengersDiv.innerHTML = '<div style="color: #dc3545;">❌ Chyba při načítání</div>';
                }
            }
        }
        
        let currentRating = 0;
        let currentRatingData = {};
        
        function rateDriver(reservationId, driverName) {
            currentRatingData = {
                reservationId: reservationId,
                driverName: driverName,
                type: 'driver'
            };
            
            document.getElementById('ratingUserName').textContent = `Hodnotit řidiče: ${driverName}`;
            document.getElementById('ratingComment').value = '';
            setRating(0);
            showSection('rating');
        }
        
        function setRating(rating) {
            currentRating = rating;
            
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star${i}`);
                if (i <= rating) {
                    star.textContent = '★'; // Plná hvězdička
                    star.style.color = '#ffc107';
                } else {
                    star.textContent = '☆'; // Prázdná hvězdička
                    star.style.color = '#ddd';
                }
            }
        }
        
        async function submitRating() {
            if (currentRating === 0) {
                showMessage('Vyberte hodnocení (1-5 hvězdiček)', 'error');
                return;
            }
            
            const comment = document.getElementById('ratingComment').value.trim();
            
            try {
                let requestData = {
                    ride_id: currentRatingData.reservationId,
                    rater_id: currentUser.id,
                    rating: currentRating,
                    comment: comment
                };
                
                if (currentRatingData.type === 'driver') {
                    requestData.driver_name = currentRatingData.driverName;
                } else if (currentRatingData.type === 'passenger') {
                    requestData.rated_id = 0; // Bude se hledat podle jména
                }
                
                const response = await fetch('/api/ratings/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const userType = currentRatingData.type === 'driver' ? 'Řidič' : 'Pasažér';
                    showMessage(`${userType} úspěšně ohodnocen!`);
                    showSection(currentRatingData.type === 'driver' ? 'reservations' : 'my-rides');
                } else {
                    showMessage(result.error || 'Chyba při hodnocení', 'error');
                }
            } catch (error) {
                showMessage('Chyba: ' + error.message, 'error');
            }
        }
        
        function ratePassenger(passengerName, rideId) {
            currentRatingData = {
                reservationId: rideId,
                passengerName: passengerName,
                type: 'passenger'
            };
            
            document.getElementById('ratingUserName').textContent = `Hodnotit pasažéra: ${passengerName}`;
            document.getElementById('ratingComment').value = '';
            setRating(0);
            showSection('rating');
        }
        
        async function showDriverReviews(driverName) {
            try {
                const response = await fetch(`/api/users/${encodeURIComponent(driverName)}/reviews`);
                const reviews = await response.json();
                
                if (reviews.length === 0) {
                    alert(`${driverName} zatím nemá žádné slovní hodnocení.`);
                    return;
                }
                
                let reviewsText = `Recenze pro ${driverName}:\n\n`;
                
                reviews.forEach(review => {
                    const stars = '*'.repeat(review.rating);
                    const date = new Date(review.created_at).toLocaleDateString();
                    reviewsText += `${stars} (${review.rating}/5)\n`;
                    reviewsText += `"${review.comment}"\n`;
                    reviewsText += `- ${review.rater_name}, ${date}\n\n`;
                });
                
                alert(reviewsText);
                
            } catch (error) {
                alert('Chyba při načítání recenzí: ' + error.message);
            }
        }
        
        // Kontrola uloženého přihlášení
        function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                } catch (e) {
                    localStorage.removeItem('currentUser');
                }
            }
        }
        
        let isTracking = false;
        let trackingInterval = null;
        let userMarkers = {};
        let searchMap = null;
        let myLocationMarker = null;
        let searchRadius = null;
        let currentLocation = null;
        let autoLocationInterval = null;
        
        function updateRangeValue(value) {
            let actualRange;
            if (value == 0) {
                actualRange = 0;
            } else {
                // Logaritmická škála: 0-300 km
                actualRange = Math.round(Math.pow(value / 100 * 300, 1.5) / 10);
                if (actualRange < 1) actualRange = 1;
                if (actualRange > 300) actualRange = 300;
            }
            
            const rangeElement = document.getElementById('rangeValue');
            if (rangeElement) {
                rangeElement.textContent = actualRange;
            }
            
            if (searchMap && searchRadius) {
                searchMap.removeLayer(searchRadius);
                searchRadius = null;
            }
            
            if (searchMap && currentLocation && actualRange > 0) {
                searchRadius = L.circle([currentLocation.lat, currentLocation.lng], {
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.1,
                    radius: actualRange * 1000
                }).addTo(searchMap);
            }
        }
        
        function initSearchMap() {
            if (searchMap) return;
            
            searchMap = L.map('searchMap').setView([49.75, 15.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(searchMap);
        }
        
        function autoUpdateLocation() {
            // Zkontroluj, zda už byl udělen souhlas s GPS
            if (localStorage.getItem('gps_permission') === 'granted') {
                if (autoLocationInterval) {
                    clearInterval(autoLocationInterval);
                }
                
                // Okamžitě načti polohu
                updateLocationOnce();
                
                // Pak aktualizuj každých 30 sekund
                autoLocationInterval = setInterval(updateLocationOnce, 30000);
            }
        }
        
        function updateLocationOnce() {
            if (!searchMap) {
                initSearchMap();
                setTimeout(updateLocationOnce, 500);
                return;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        currentLocation = { lat, lng };
                        
                        // Odstraň starý marker a kruh
                        if (myLocationMarker) searchMap.removeLayer(myLocationMarker);
                        if (searchRadius) searchMap.removeLayer(searchRadius);
                        
                        // Přidej marker mé polohy
                        myLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #007bff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                                iconSize: [22, 22],
                                iconAnchor: [11, 11]
                            })
                        }).addTo(searchMap);
                        
                        // Přidej kruh vzdálenosti
                        const rangeSlider = document.getElementById('searchRange').value;
                        if (rangeSlider > 0) {
                            const actualRange = Math.round(Math.pow(rangeSlider / 100 * 300, 1.5) / 10);
                            if (actualRange > 0) {
                                searchRadius = L.circle([lat, lng], {
                                    color: '#007bff',
                                    fillColor: '#007bff',
                                    fillOpacity: 0.1,
                                    radius: actualRange * 1000
                                }).addTo(searchMap);
                            }
                        }
                        
                        myLocationMarker.bindPopup('📍 Vaše aktuální poloha (automaticky aktualizováno)');
                        
                        // Načti a zobraz aktivní řidiče
                        loadActiveDrivers();
                    },
                    (error) => {
                        console.log('GPS nedostupné:', error);
                    },
                    { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                );
            }
        }
        
        async function loadActiveDrivers() {
            try {
                const response = await fetch('/api/users/locations');
                const locations = await response.json();
                
                // Odstraň staré markery řidičů
                Object.keys(userMarkers).forEach(userId => {
                    if (userMarkers[userId] && searchMap.hasLayer(userMarkers[userId])) {
                        searchMap.removeLayer(userMarkers[userId]);
                    }
                });
                userMarkers = {};
                
                // Přidej nové markery aktivních řidičů
                locations.forEach(loc => {
                    if (loc.user_id !== currentUser?.id) { // Nezobrazuj sebe
                        const marker = L.marker([loc.lat, loc.lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">🚗</div>',
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(searchMap);
                        
                        marker.bindPopup(`
                            <div style="text-align: center;">
                                <h4>🚗 ${loc.user_name}</h4>
                                <p>Aktivní řidič</p>
                                <small>Aktualizováno: ${new Date(loc.updated_at).toLocaleTimeString()}</small>
                            </div>
                        `);
                        
                        userMarkers[loc.user_id] = marker;
                    }
                });
            } catch (error) {
                console.log('Nelze načíst aktivní řidiče:', error);
            }
        }
        
        function showMyLocation() {
            if (!searchMap) {
                initSearchMap();
                setTimeout(showMyLocation, 500);
                return;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        currentLocation = { lat, lng };
                        
                        // Odstraň starý marker a kruh
                        if (myLocationMarker) searchMap.removeLayer(myLocationMarker);
                        if (searchRadius) searchMap.removeLayer(searchRadius);
                        
                        // Přidej marker mé polohy
                        myLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #007bff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                                iconSize: [22, 22],
                                iconAnchor: [11, 11]
                            })
                        }).addTo(searchMap);
                        
                        // Přidej kruh vzdálenosti
                        const rangeSlider = document.getElementById('searchRange').value;
                        if (rangeSlider > 0) {
                            const actualRange = Math.round(Math.pow(rangeSlider / 100 * 300, 1.5) / 10);
                            if (actualRange > 0) {
                                searchRadius = L.circle([lat, lng], {
                                    color: '#007bff',
                                    fillColor: '#007bff',
                                    fillOpacity: 0.1,
                                    radius: actualRange * 1000
                                }).addTo(searchMap);
                            }
                        }
                        
                        // Vycentruj mapu
                        searchMap.setView([lat, lng], 12);
                        
                        // Ulož souhlas s GPS pro budoucí automatické sledování
                        localStorage.setItem('gps_permission', 'granted');
                        
                        myLocationMarker.bindPopup('📍 Vaše aktuální poloha').openPopup();
                        showMessage('Poloha nalezena! Automatické sledování zapnuto.');
                        
                        // Spusť automatické sledování
                        autoUpdateLocation();
                    },
                    (error) => {
                        showMessage('Nelze získat GPS polohu', 'error');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
                );
            } else {
                showMessage('GPS není podporováno', 'error');
            }
        }
        
        function startLocationTracking() {
            if (!currentUser) {
                showMessage('Musíte být přihlášeni!', 'error');
                return;
            }
            
            if (isTracking) {
                stopLocationTracking();
                return;
            }
            
            if (navigator.geolocation) {
                isTracking = true;
                document.getElementById('trackingBtn').textContent = '⏹️ Zastavit sdílení';
                
                trackingInterval = setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            // Ulož polohu na server
                            fetch('/api/users/location', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    user_id: currentUser.id,
                                    lat: lat,
                                    lng: lng
                                })
                            });
                            
                            // Aktualizuj vlastní marker
                            updateUserMarker(currentUser.id, currentUser.name, lat, lng, true);
                        },
                        (error) => {
                            console.error('GPS chyba:', error);
                            stopLocationTracking();
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
                    );
                }, 10000); // Aktualizace každých 10 sekund
                
                showMessage('Sdílení polohy zapínuto');
            } else {
                showMessage('GPS není podporováno', 'error');
            }
        }
        
        function stopLocationTracking() {
            isTracking = false;
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            document.getElementById('trackingBtn').textContent = '📍 Sdílet polohu';
            showMessage('Sdílení polohy vypnuto');
        }
        
        function updateUserMarker(userId, userName, lat, lng, isCurrentUser = false) {
            if (!map) return;
            
            // Odstraň starý marker
            if (userMarkers[userId]) {
                map.removeLayer(userMarkers[userId]);
            }
            
            let marker;
            
            if (isCurrentUser) {
                // Vlastní poloha - modrá tečka
                marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background: #007bff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    })
                }).addTo(map);
            } else {
                // Ostatní uživatelé - zelený marker s autem
                marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">🚗</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
            }
            
            marker.bindPopup(`
                <div style="text-align: center;">
                    <h4>${userName}</h4>
                    <p>${isCurrentUser ? 'Vaše poloha' : 'Aktuální poloha'}</p>
                    <small>${new Date().toLocaleTimeString()}</small>
                </div>
            `);
            
            userMarkers[userId] = marker;
        }
        
        async function showAllUserLocations() {
            try {
                const response = await fetch('/api/users/locations');
                const locations = await response.json();
                
                locations.forEach(loc => {
                    updateUserMarker(loc.user_id, loc.user_name, loc.lat, loc.lng, loc.user_id === currentUser?.id);
                });
                
                showMessage(`Zobrazeno ${locations.length} uživatelů na mapě`);
            } catch (error) {
                showMessage('Chyba při načítání poloh', 'error');
            }
        }
        
        // Cookie consent
        function showCookieConsent() {
            if (!localStorage.getItem('cookieConsent')) {
                document.getElementById('cookieConsent').style.display = 'block';
            }
        }
        
        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'accepted');
            document.getElementById('cookieConsent').style.display = 'none';
        }
        
        // Inicializace
        checkSavedLogin();
        updateUI();
        
        // Zobraz cookie consent po načtení
        setTimeout(showCookieConsent, 2000);
        
        // Inicializuj slider hodnotu
        setTimeout(() => {
            const slider = document.getElementById('searchRange');
            if (slider) {
                updateRangeValue(slider.value);
            }
        }, 100);
    </script>
</body>
</html>